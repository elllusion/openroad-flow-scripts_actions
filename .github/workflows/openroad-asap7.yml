name: OpenROAD Flow For asap7

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  openroad:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          cmake \
          swig \
          tcl-dev \
          libboost-all-dev \
          libeigen3-dev \
          flex bison \
          libspdlog-dev \
          libgtest-dev \
          tcl-tclreadline \
          python3 python3-pip \
          time

      - name: Clone OpenROAD-flow-scripts
        run: |
          git clone --depth=1 https://github.com/The-OpenROAD-Project/OpenROAD-flow-scripts.git
          cd OpenROAD-flow-scripts
          git submodule update --recursive --init
          sudo ./etc/DependencyInstaller.sh -base && sudo ./etc/DependencyInstaller.sh -common

      - name: Use prebuilt OpenROAD install
        run: |
          mkdir -p OpenROAD-flow-scripts/tools/install
          tar -xf install.tar.xz -C OpenROAD-flow-scripts/tools/install
          ldd OpenROAD-flow-scripts/tools/install/yosys/bin/yosys-abc

      - name: Copy user design
        run: |
          mkdir -p OpenROAD-flow-scripts/flow/designs/src/cm0ikmcu
          mkdir -p OpenROAD-flow-scripts/flow/designs/src/cm0ikmcu/core
          mkdir -p OpenROAD-flow-scripts/flow/designs/src/cm0ikmcu/dap
          mkdir -p OpenROAD-flow-scripts/flow/designs/src/cm0ikmcu/ualdis
          mkdir -p OpenROAD-flow-scripts/flow/designs/asap7/cm0ikmcu
          cp -r designs/cm0ikmcu/src/*.v OpenROAD-flow-scripts/flow/designs/src/cm0ikmcu/
          cp -r designs/cm0ikmcu/src/core/*.v OpenROAD-flow-scripts/flow/designs/src/cm0ikmcu/core
          cp -r designs/cm0ikmcu/src/dap/*.v OpenROAD-flow-scripts/flow/designs/src/cm0ikmcu/dap
          cp -r designs/cm0ikmcu/src/ualdis/*.v OpenROAD-flow-scripts/flow/designs/src/cm0ikmcu/ualdis
          cp designs/cm0ikmcu/rules-base.json OpenROAD-flow-scripts/flow/designs/asap7/cm0ikmcu/
          cp designs/cm0ikmcu/config.mk OpenROAD-flow-scripts/flow/designs/asap7/cm0ikmcu/
          cp designs/cm0ikmcu/constraint.sdc OpenROAD-flow-scripts/flow/designs/asap7/cm0ikmcu/
          
      - name: Run OpenROAD Flow
        run: |
          pip3 install pyyaml
          cd OpenROAD-flow-scripts/flow
          make DESIGN_CONFIG=./designs/asap7/cm0ikmcu/config.mk

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: openroad-results
          path: OpenROAD-flow-scripts/flow/results/asap7/cm0ikmcu
